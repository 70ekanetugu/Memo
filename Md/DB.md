# DB基礎
## 用語
1. トランザクション
  - 処理のひとまとまりの事。DBであれば１つのDMLであり、java等であればメソッド単位であるのが一般的。
2. トランザクションのリード現象
    トランザクションが参照するデータや変更したデータを、他のトランザクションとどのように分離するか指定するためのもの。
    - ダーティリード
      - あるトランザクションが処理途上でストレージに書き込んだ未確定なデータを他のトランザクションが読みこんでしまうこと。
      - 具体的には、コミット前に他のトランザクションがデータをReadし、コミット側がロールバックした場合におこる。
    - ファントムリード
      - あるトランザクションがテーブル参照している時、他トランザクションのレコード追加(削除)により参照するテーブルデータが異なってしまう現象のこと。
      - データの正当性が確保できない
    - ノンリポータブルリード
      - ファントムリードのレコード更新ver。
      - これもReadするレコードデータが変わってしまうので、正当性が保証されない

3. トランザクションの分離レベル
  前述リード現象の対策として、トランザクションが参照または変更するデータを、他のトランザクションとどのように分離するか指定したレベルのこと。
  アプリ側、DB側どちらでも設定可能。当然だが実際に利用できる分離レベルはDBの実装による。

| 分離レベル         | Dirty Reads | Non-Repetable Reads | Phantoms Reads |
| ---               | ---         | ---                 | ---            |
| READ_ UNCOMMITED  | ✕          | ✕                   | ✕             |
| READ_COMMITED     | 〇          | ✕                   | ✕             |
| REPEATABLE_READ   | 〇          | 〇                  | ✕              |
| SERIALIZABLE      | 〇          | 〇                  | 〇              |

4. トランザクション伝搬レベル
   トランザクション協会でトランザクションへ参加する方法を指定する。
   大見く分けると、独立した逐次実行か、入れ子実装か、並列実行かの違い。
   - 逐次
     - 各々のトランザクションが順番に実行され独立している為、境界を意識する必要はない。
   - 入れ子
     - トランザクション対象のメソッド内で、さらにトランザクション対象のメソッドを呼び出した場合などに該当。
     - 伝搬レベルを考慮する必要がある。
   - 並列
     - マルチスレッド

| 伝搬レベル        | 説明                                               | 
| ---              | ---                                                |
| REQUIRED         | 現在のトランザクションを継続利用。                     |
| REQUIRES_NEW     | 必ず新規のトランザクションを作成開始する。             |
| MANDATORY        |                                                    |
| NEVER            | トランザクションの対象外とする                         |
| NOT_SUPPORTED    | トランザクションの対象外とする                         |
| SUPPORTS         |                                                    |
| NESTED           |                                                |

### 伝搬レベル考慮例
処理内容をトレースするのログをDBに保存しているアプリを考える。  
ビジネスロジックにエラーが起こり、業務データをロールバックする時、ログデータはコミットしたい。
このような場合はトランザクション境界が入れ子とするため、REQUIRED_NEWを指定する。
仮にREQUIREDだった場合、ログデータも一緒にロールバックされてしまう。


