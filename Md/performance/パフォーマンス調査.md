# パフォーマンス調査基礎
# 目次


# Linuxコマンド
## topコマンド
OSのプロセス数や各プロセスの状態及びリソースの利用状況がわかる。  
その為、基本的には調査の導入的な用途。  
この結果を基に、調査を進めていく事になる。  

### コマンドオプション
```shell
$ top #CPU使用率順にソート
$ top -a #メモリ使用率順にソート
$ top -p [PID] #指定したプロセスを監視
$ top -d1 #1秒ごとに更新(デフォルトは3秒)
```
### 出力の見方
- load average : `uptime`コマンドでも同じ出力が確認できる。
```shell
top - 00:00:00 up 0min, 5 users, load average: 2.00, 2.00, 2.00
# 現在時刻
# 稼働時間
# ログインユーザ数
# 左から、1min 5min 15min間のたんいじかんあたりの待ちタスク数
```  

- Tasks
```shell
Tasks: 100 total, 10 running, 50 sleeping, 10 stopped, 0 zombie
# タスクの総数
# タスクのうち実行中のもの
# 待機中のタスク(CPU待ち?)
# 停止中タスク(ネットワークやIO待ち?)
# ゾンビタスク
```

- CPU: 通常見るのは、us~waの項目？
```shell
CPU(s): 80%us, 9.0%sy, 0.5%ni, 0.5%id, 20%wa, 0.0%hi, 1.0%si, 2.0%st
# us: userがCPUを使用した時間(通常のユーザプログラムが動作している時間)
# sy: システムがCPUを使用した時間(カーネルモードの時間)
# ni: user niceがCPUを使用した時間(niceはプロセスの優先度であり正だとlow,負だとhigh)
# id: CPUのidole時間(仕事をしていない時間)
# wa: io待ちの時間
# hi: ハードウェアによる割り込み時間。hardware interrupt?
# si: ソフトウェアの割り込み時間。software interrupt
# st: 仮想マシンの仮想CPUで使用されており待たされている時間
```
- Mem/Swap: 物理メモリとスワップ領域の使用状況。`free`でも同じ出力を得られる。
```shell
Mem: 100000k total,  5000k used, 4000k free, 1000k buffers
Swap: 0k total, 0k used, 0k free, 1000k cached
# buffers: mallocなどでバッファとして利用されているメモリ量。ヒープ?
# cached: キャッシュとして利用されているメモリ量
```

- プロセス毎のデータ
  - PR: 優先度
  - NI: nice値。正なら優先度低く、負なら高い。0は基準であり、ディスパッチャの判定基準にならない？
  - VIRT: 確保された仮想メモリサイズ。スワップも含む
  - RES: スワップしていない使用物理メモリサイズ
  - SHR: 他プロセスと共有しているメモリサイズ
  - S: プロセスの状態。
    - R: Runnning(実行中または実効可能状態)
    - S: Sleeping(ネットワークの応答待ちなども含む)
    - D: Uninterruptible sleep(IO待ち)
    - Z: ゾンビ状態
  - %CPU: CPU利用率
  - %MEM: メモリ利用率
  - TIME+: プロセス起動からの経過時間
  - COMMAND: プロセスコマンド

## psコマンド
### オプション
```shell
$ ps #デーモン以外の自分が実行したプロセスを表示
$ ps a #自分以外のユーザプロセスも表示
$ ps x #デーモンプロセスを表示
$ ps u #ユーザ名と開始時刻を表示
```
### 出力見方
- TTY : 仮想端末。UNIX系は、過去の名残で入出力を仮想端末をいう概念を用いて行う。プロセスがどのTTYを利用しているかを示している。
- TIME : プロセスが実際にCPUを使った時間
- CMD : プロセスの実行コマンド 
- %CPU : プロセスのCPU利用率(CPU利用時間/実際の時間)
- %MEM : プロセスが確保している物理メモリの百分率
- VSZ, RSS : プロセスが確保した仮想メモリと物理メモリ領域のサイズ
- STAT : プロセスの状態(R, S, D, Z)


# Javaコマンド
## jstackコマンド
指定されたjavaプロセスに対する、javaスレッドのスタックトレースを出力するためのもの。(スレッドダンプの取得)  
スレッドダンプは一定の間隔(10秒程度)で、10個取るのが一般的な習慣。
```shell
# まずはプロセスIDを調べる。以下以外にも、jpsというJDKのコマンドがあるのでそちらでも良い。
$ ps -el | grep java

# 対象のPIDがわかったら、jstackでスレッドダンプをとる。リダイレクトを「追加」にしているのは、1つのファイルにスレッドダンプをまとめるため。(ファイル分けると面倒なので)
$ jstack -l <pid> >> thread_dump.log
or
$ sudo -u <java-user> jstack -l <pid> #java-userはjavaプロセスを実行するユーザのID



```
